<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Form</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
<button onclick="redirectToClient()">Go to Client Page</button>
<h1>Booking Form</h1>

<form id="bookingForm" onsubmit="return handleSubmit(event)">
    <h2>Flight Details</h2>
    <label for="airwaybill">Airway Bill:</label>
    <input type="text" id="airwaybill" name="airwaybill" required><br><br>

    <label for="origin">Origin:</label>
    <input type="text" id="origin" name="origin" required><br><br>

    <label for="destination">Destination:</label>
    <input type="text" id="destination" name="destination" required><br><br>

    <label for="date">Date:</label>
    <input type="date" id="date" name="date" required><br><br>

    <label for="flight">Flight:</label>
    <input type="text" id="flight" name="flight" required><br><br>

    <label for="rateClass">Rate Class:</label>
    <input type="text" id="rateClass" name="rateClass" required><br><br>

    <label for="priority">Priority:</label>
    <input type="text" id="priority" name="priority" required><br><br>

    <label for="shipper">Shipper:</label>
    <input type="text" id="shipper" name="shipper" required><br><br>

    <label for="consignee">Consignee:</label>
    <input type="text" id="consignee" name="consignee" required><br><br>

    <label for="agent">Agent:</label>
    <input type="text" id="agent" name="agent" required><br><br>

    <h2>Cargo Details</h2>
    <table id="cargoTable">
        <thead id="cargoTableHead" >
            <tr id="cargoTableRow">
                <th>Pieces</th>
                <th>Packing</th>
                <th>Weight</th>
                <th>Length</th>
                <th>Width</th>
                <th>Height</th>
                <th>Volume</th>
                <th>Reference</th>
                <th>Note</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="number" name="pieces[]" required></td>
                <td><input type="text" name="packing[]" required></td>
                <td><input type="number" name="weight[]" step="0.01" required></td>
                <td><input type="number" name="length[]" step="0.01" required></td>
                <td><input type="number" name="width[]" step="0.01" required></td>
                <td><input type="number" name="height[]" step="0.01" required></td>
                <td><input type="number" name="volume[]" step="0.01" required></td>
                <td><input type="text" name="reference[]" required></td>
                <td><input type="text" name="note[]" required></td>
                <td>
                    <button type="button" onclick="removeRow(this)">Remove</button>
                    <button type="button" onclick="deleteRow(this)">Delete Cargo</button>
                </td>
            </tr>
        </tbody>
    </table>
    <button type="button" onclick="addRow()">Add Cargo</button>

    <h3>Totals</h3>
    <label for="totalPieces">Total Pieces:</label>
    <input type="number" id="totalPieces" readonly><br><br>

    <label for="totalWeight">Total Weight:</label>
    <input type="number" id="totalWeight" step="0.01" readonly><br><br>

    <label for="totalVolume">Total Volume:</label>
    <input type="number" id="totalVolume" step="0.01" readonly><br><br>

    <button type="submit">Submit Booking</button>
</form>

<script>
    function redirectToClient() {
        window.location.href = 'tracking.html'; // Redirige a cliente.html
    }
    function addRow() {
        const table = document.getElementById("cargoTable").getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        
        const piecesCell = newRow.insertCell(0);
        piecesCell.innerHTML = '<input type="number" name="pieces[]" required>';

        const packingCell = newRow.insertCell(1);
        packingCell.innerHTML = '<input type="text" name="packing[]" required>';

        const weightCell = newRow.insertCell(2);
        weightCell.innerHTML = '<input type="number" name="weight[]" step="0.01" required>';

        const lengthCell = newRow.insertCell(3);
        lengthCell.innerHTML = '<input type="number" name="length[]" step="0.01" required>';

        const widthCell = newRow.insertCell(4);
        widthCell.innerHTML = '<input type="number" name="width[]" step="0.01" required>';

        const heightCell = newRow.insertCell(5);
        heightCell.innerHTML = '<input type="number" name="height[]" step="0.01" required>';

        const volumeCell = newRow.insertCell(6);
        volumeCell.innerHTML = '<input type="number" name="volume[]" step="0.01" required>';

        const referenceCell = newRow.insertCell(7);
        referenceCell.innerHTML = '<input type="text" name="reference[]" required>';

        const noteCell = newRow.insertCell(8);
        noteCell.innerHTML = '<input type="text" name="note[]" required>';

        const actionCell = newRow.insertCell(9);
        actionCell.innerHTML = '<button type="button" onclick="removeRow(this)">Remove</button> <button type="button" onclick="deleteRow(this)">Delete Cargo</button>';
    }
    function removeRow(button) {
        const row = button.closest('tr');
        row.remove();
        calculateTotals();
    }
    function deleteRow(button) {
        const row = button.closest('tr');
        row.remove();
        calculateTotals();
    }
    function calculateTotals() {
        let totalPieces = 0;
        let totalWeight = 0;
        let totalVolume = 0;

        const pieces = document.getElementsByName('pieces[]');
        const weight = document.getElementsByName('weight[]');
        const volume = document.getElementsByName('volume[]');

        for (let i = 0; i < pieces.length; i++) {
            totalPieces += parseInt(pieces[i].value) || 0;
            totalWeight += parseFloat(weight[i].value) || 0;
            totalVolume += parseFloat(volume[i].value) || 0;
        }

        document.getElementById('totalPieces').value = totalPieces;
        document.getElementById('totalWeight').value = totalWeight.toFixed(2);
        document.getElementById('totalVolume').value = totalVolume.toFixed(2);
    }

    document.getElementById('cargoTable').addEventListener('input', calculateTotals);

    // Función que se ejecutará en el onsubmit
    function handleSubmit2(event) {
        event.preventDefault();

        const token = sessionStorage.getItem('jwtToken');
        if (!token) {
            alert('Token not found. Please log in.');
            window.location.href = 'login.html'; // Redirigir a la página de login
            return;
        }

        const formData = new FormData(document.getElementById('bookingForm'));
        console.log("antes:",formData.entries());
        formData.forEach((value, key) => {
            console.log("iterando a :",key);
            if (key.endsWith('[]')) {
                console.log("trajo valor");
                // Agrupar datos de la tabla cargo
                formData.delete(key);
            }else{
                console.log("no trajo valor");
            }
        });
        const data = Object.fromEntries(formData.entries());
        console.log("antes:",formData.entries());
        // Agrupar datos de la tabla cargo en un array
        const cargoRows = document.querySelectorAll('#cargoTable tbody tr');
        const cargoData = Array.from(cargoRows).map(row => {
            return {
                pieces: row.querySelector('input[name="pieces[]"]').value,
                packing: row.querySelector('input[name="packing[]"]').value,
                weight: row.querySelector('input[name="weight[]"]').value,
                length: row.querySelector('input[name="length[]"]').value,
                width: row.querySelector('input[name="width[]"]').value,
                height: row.querySelector('input[name="height[]"]').value,
                volume: row.querySelector('input[name="volume[]"]').value,
                reference: row.querySelector('input[name="reference[]"]').value,
                note: row.querySelector('input[name="note[]"]').value
            };
        });

        // Incluir los datos de cargo en el objeto final
        const finalData = {
            ...data,
            cargo: cargoData,
            totalPieces: parseInt(document.getElementById('totalPieces').value),
            totalWeight: parseFloat(document.getElementById('totalWeight').value),
            totalVolume: parseFloat(document.getElementById('totalVolume').value)
        };
        fetch('http://localhost:3000/api/v1/booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(finalData)
        }).then(response => response.json())
          .then(data => {
              console.log('Success:', data);
              alert('Booking submitted successfully!');
          }).catch((error) => {
              console.error('Error:', error);
              alert('Error submitting booking.');
          });
    };

    function handleSubmit(event) {
        event.preventDefault();
    
        const token = sessionStorage.getItem('jwtToken');
        if (!token) {
            alert('Token not found. Please log in.');
            window.location.href = 'login.html'; // Redirigir a la página de login
            return;
        }
    
        // Obtener datos del formulario
        const formData = new FormData(document.getElementById('bookingForm'));
        
        // Construir el objeto final excluyendo los campos no deseados
        const data = {};
        const cargoData = [];
        
        formData.forEach((value, key) => {
            // Filtrar campos que no deben ser recogidos
            if (key.endsWith('[]')) {
                // Agrupar datos de la tabla cargo
                const baseKey = key.slice(0, -2); // Eliminar '[]' del final del nombre
                if (!data[baseKey]) {
                    data[baseKey] = [];
                }
                data[baseKey].push(value);
            } else {
                // Añadir otros campos del formulario
                data[key] = value;
            }
        });
        
        // Agrupar los datos de cargo en objetos
        const cargoRows = data.pieces.map((_, index) => ({
            pieces: data.pieces[index],
            packing: data.packing[index],
            weight: data.weight[index],
            length: data.length[index],
            width: data.width[index],
            height: data.height[index],
            volume: data.volume[index],
            reference: data.reference[index],
            note: data.note[index]
        }));
          // Eliminar los campos individuales que se usan solo para construir el objeto cargo
        delete data.pieces;
        delete data.packing;
        delete data.weight;
        delete data.length;
        delete data.width;
        delete data.height;
        delete data.volume;
        delete data.reference;
        delete data.note;
        // Incluir los datos de cargo en el objeto final
        const finalData = {
            ...data,
            cargo: cargoRows,
            totalPieces: parseInt(document.getElementById('totalPieces').value),
            totalWeight: parseFloat(document.getElementById('totalWeight').value),
            totalVolume: parseFloat(document.getElementById('totalVolume').value)
        };
    
        // Enviar datos al servidor
        fetch('http://localhost:3000/api/v1/booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(finalData)
        }).then(response => response.json())
          .then(data => {
              console.log('Success:', data);
              alert('Booking submitted successfully!');
          }).catch((error) => {
              console.error('Error:', error);
              alert('Error submitting booking.');
          });
    }
</script>

</body>
</html>
